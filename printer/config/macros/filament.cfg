[gcode_macro LOAD_FILAMENT]
gcode:
    SAVE_GCODE_STATE NAME=load
    M83
    G1 E40  F350
    G1 E40  F300
    G1 E10 F300
    G1 E-1.7 F1500
    M117 LOAD Complete
    CLEAR_DISP TIMEOUT=10
    RESTORE_GCODE_STATE NAME=load

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set DISTANCE = params.DISTANCE|default(49)|float %}
    M400
    SAVE_GCODE_STATE NAME=unload_state
    M117 Unloading...
    M83
    G1 E5 F600  ; Extrude a little to soften the tip
    M82    ;Absolute extrusion
    G92 E0
    G1 E2 F3600
    G1 E0 F3600
    G1 E4 F3600
    G1 E0 F3600
    G1 E8 F3600
    G1 E0 F3600
    M83                  ;Relative extrusion
    G1 E-25 F3600
    G4 P3000
    G1 E{DISTANCE * -1} F3000
    M82 ; Absolute extrusion
    M400
    M117 Done!
    CLEAR_DISP TIMEOUT=10
    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro CHANGE_FILAMENT]
gcode:
    {% set TEMP = params.TEMP|int %}
    {% set user_vars = printer["gcode_macro USER_VARIABLES"] %}
    {% set position = namespace(x=user_vars.macros.park_position.filament_change.x,
                                y=user_vars.macros.park_position.filament_change.y,
                                z=user_vars.macros.park_position.filament_change.z) %}
    SAVE_GCODE_STATE NAME=change_filament

    {% if printer.pause_resume.is_paused %}
      {% if printer.toolhead.position.z > 100 %}
        {% set position.z = printer.toolhead.position %}
      {% endif %}
    {% else %}
      {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
      {% endif %}
    {% endif %}
    G90
    G0 X{position.x} Y{position.y} Z{position.z} F8000
    M109 S{TEMP}

    RESTORE_GCODE_STATE NAME=change_filament
